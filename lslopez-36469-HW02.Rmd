---
title: "36-469 Homework 02, Fall 2021"
author: "Leandro Lopez Leon (lslopez)"
date: "Sunday, Sept. 26, 2021" 
output:
  pdf_document:
    toc: no
  html_document:
    toc: true
    toc_float: true
    theme: spacelab
---

```{r wrap-hook,echo=FALSE}
    library(knitr)
    library(tidyverse)
    hook_output = knit_hooks$get('output')
    knitr::opts_chunk$set(echo = F, warning = F, message = F)
    knit_hooks$set(output = function(x, options) {
      # this hook is used only when the linewidth option is not NULL
      if (!is.null(n <- options$linewidth)) {
        x = knitr:::split_lines(x)
        # any lines wider than n should be wrapped
        if (any(nchar(x) > n)) x = strwrap(x, width = n)
        x = paste(x, collapse = '\n')
      }
      hook_output(x, options)
    })
```

## Q1
**A**.  

*Compute the OR for actn3_rs540874*
```{r}
    source("https://raw.githubusercontent.com/xuranw/469_public/master/hw2/hw2_functions.R")
    famuss <- read.csv("https://raw.githubusercontent.com/xuranw/469_public/master/hw2/synthetic_famuss.csv")
    or_df <- famuss %>% subset(., actn3_rs540874 != 2) %>%
             select(actn3_rs540874, heart_disease)
    D_A <- table(or_df)[2,2]
    H_A <- table(or_df)[2,1]
    D_a <- table(or_df)[1,2]
    H_a <- table(or_df)[1,1]
    (D_A / H_A) /  (D_a / H_a)
```
*Interpretation*
Observe that $OR \approx 1$, which suggests that the risk factor `actn3_rs540874` (in isolation) is not significantly associated with the heart disease. 

**B**.  
*Use logistic regression with the glm function to regress only heart disease onto all 79 SNP’s (i.e., not including the variable `norm_BMI`). Plot these approximate OR’s*

```{r}
    glm_famuss <- famuss[, -which(colnames(famuss) == "norm_BMI")]
    logistic_regression  <- function(dataset, BMI) {
        glm_res <- stats::glm(dataset$heart_disease ~ . , data = dataset, family = stats::binomial)
        pred_vec1 <-  stats::predict(glm_res, newx = dataset, type = "response")
        pred_vec1 <- as.numeric(pred_vec1 >= 0.5) # converting it to a 0-1
        misclassification_rate  <- 1 - sum(dataset$heart_disease == pred_vec1) / length (dataset$heart_disease)
        b_js <- stats::coef(glm_res)
        alphabetical_bjs <- b_js[order(names(b_js))]
        ors <- data.frame(c(as.vector(unlist(lapply(alphabetical_bjs, exp)))),
                          1:length(b_js))
        names(ors) <- c("ORs", "x")
        title_string <- paste("Regression (without BMI)\nMisclassification: ",
                             misclassification_rate)
        ggplot(data = ors, ggplot2::aes(x = x, y = ORs)) +
        geom_point() +
        geom_hline(yintercept = .8, linetype = "dotted", col = "red") +
        geom_hline(yintercept = 1, col = "red") +
        geom_hline(yintercept = 1.2,linetype = "dotted", col = "red") + 
        labs(x = "SNP order (alphabetical)",
             y = "Estimated OR",
             title = ifelse(BMI == T, "Regression (with BMI)", "Regression (without BMI)"), 
             subtitle = paste("Misclassification: ", misclassification_rate))
        rm(glm_res, pred_vec1, misclassification_rate, b_js, alphabetical_bjs, ors, title_string, dataset)
    }
    logistic_regression(glm_famuss, F)
```
# Functions seems to work in code chunk
```{r}
        glm_res <- stats::glm(glm_famuss$heart_disease ~ . , data = glm_famuss, family = stats::binomial)
        pred_vec1 <-  stats::predict(glm_res, newx = glm_famuss, type = "response")
        pred_vec1 <- as.numeric(pred_vec1 >= 0.5) # converting it to a 0-1
        misclassification_rate  <- 1 - sum(glm_famuss$heart_disease == pred_vec1) / length (glm_famuss$heart_disease)
        b_js <- stats::coef(glm_res)
        alphabetical_bjs <- b_js[order(names(b_js))]
        ors <- data.frame(c(as.vector(unlist(lapply(alphabetical_bjs, exp)))),
                          1:length(b_js))
        names(ors) <- c("ORs", "x")
        title_string <- paste("Regression (without BMI)\nMisclassification: ",
                             misclassification_rate)
        ggplot(data = ors, ggplot2::aes(x = x, y = ORs)) +
        geom_point() +
        geom_hline(yintercept = .8, linetype = "dotted", col = "red") +
        geom_hline(yintercept = 1, col = "red") +
        geom_hline(yintercept = 1.2,linetype = "dotted", col = "red") + 
        labs(x = "SNP order (alphabetical)",
             y = "Estimated OR",
             title = "Regression (without BMI)")
```
**C**.  
*We now include `norm_BMI`*

```{r}
    logistic_regression(famuss, T)
```
